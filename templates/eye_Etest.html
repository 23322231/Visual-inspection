<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>視力測驗</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #testImage {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>視力測驗 E 字圖片</h1>
    <button onclick="getallsizeAndsend()">確認</button>

    <div id="imageContainer">
        <img id="eImage" src="" style="display:none;" />
    </div> <!-- 用來顯示 E 字圖片的區域 -->

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // 初始化 WebSocket 連接
        var socket = io.connect('http://192.168.1.179:5000');
        
        var urlParams = new URLSearchParams(window.location.search);
        var session = urlParams.get('session');
        var depth = urlParams.get('depth');

        // WebSocket 連接成功時的處理
        socket.on('connect', function() {
            console.log('WebSocket 連接已打開');
        });
    
        var widthPx,heightPx;
        function getallsizeAndsend() {

            // // 當頁面加載時請求數據
            socket.emit('request_width_height');
            socket.on('get_width_height', function(data) {
                console.log("????????:)??????????????????");
                // screenSizeInch = data.screen_size;  // 螢幕尺寸
                widthPx = data.screen_width;  // 取得參考物件的寬度（像素）
                heightPx = data.screen_height;// 取得參考物件的高度（像素）
                
                console.log(widthPx, heightPx);
            });
            if (depth) {
                        calculateAndSendSizes();
            }
        }
    
        function calculateAndSendSizes() {
            const knownWidthCm =8.56;//信用卡的寬度(CM)
            const knownHeightCm =5.4;//信用卡的高度(CM)
            const maxWidthCm = 8.73; //最大E字寬度(CM)
    
            const widthInch = knownWidthCm / 2.54; //將公分轉換為英吋
            const heightInch = knownHeightCm / 2.54; //將公分轉換為英吋
            //卡片對角線尺寸
            const diagonalInch = Math.sqrt(Math.pow(widthInch, 2) + Math.pow(heightInch, 2));
            const ppi = Math.sqrt(widthPx ** 2 + heightPx ** 2) / diagonalInch;  // 計算 PPI
            console.log(ppi);
            console.log(`PPI: ${ppi}, Depth: ${depth}`);
    
            // 傳送 PPI 和距離到後端
            socket.emit('calculate_sizes', { 'ppi': ppi, 'depth': depth });
    
            // 接收後端計算的 E 字圖片尺寸，依序顯示
            socket.on('display_sizes', (data) => {
                const imageContainer = document.getElementById('imageContainer');
                imageContainer.innerHTML = '';  //清空舊內容
    
                data.sizes.forEach((size, index) => {
                    const img = document.createElement('img');
                    img.src = 'static/e_chart/right.jpg';  
                    img.style.width = `${size}px`;  //設定圖片的寬度
                    img.style.display = 'block';
                    img.style.margin = '10px auto';
                    imageContainer.appendChild(img);
                });
            });
        }
        
        window.onload = function() {
            getallsizeAndsend();
        }
        
    </script>
    
</body>
</html>
